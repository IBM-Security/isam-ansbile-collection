---
- name: Help INFO (-e help=true)
  pause:
    echo: yes
    prompt: |
      NAME
        import_keytab_files
      
      DESCRIPTION
        Role to import multiple kerberos keytab files
      
      STEPS
        1) import multiple kerberos keytab files
        2) Commit changes
      
      EXAMPLES
        ansible-playbook -i [...] playbooks/ansible_collections/web/import_keytab_files.yml 
        ansible-playbook -i [...] playbooks/ansible_collections/web/import_keytab_files.yml -e name=default.krb5 // limit import to a specific file from inventory !ATTENTION!: only basename from path variable is used for filtering
      
      INVENTORY
      ==========
      # import multiple kerberos keytbal files
      # !ATTENTION! ibmsecurity library supports id + file parameter but appliance REST API does not support that the same file with different id is imported
      # Therefore relying only on file parameter for this role
      keytab_files:
        - file: files/kerberos/default.krb5
        - file: /ansible/inventory/simple/files/kerberos/another.krb5
      ==========
      
      INTERACTION
        ENTER         = continue
        Ctrl+C + 'C'  = continue
        Ctrl+C + 'A'  = abort
  when: help is defined
- name: Import kerberos keytab files
  ibm.isam.isam:
    log:       "{{ log_level | default(omit) }}"
    force:     "{{ force | default(omit) }}"
    action: ibmsecurity.isam.web.kerberos_configuration.keyfiles.import_keytab
    isamapi:
      id: "{{ item.file | basename }}"
      file: "{{ item.file if((item.file | regex_search('^/')) == '/') else (inventory_dir +'/'+ item.file) }}"
  when: item.file is defined and (item.file | basename) == name
  with_items: "{{ keytab_files }}"
  loop_control:
    label: "{ id: \"{{ item.file | basename }}\", file: \"{{ item.file }}\" }"
  notify: Commit Changes
